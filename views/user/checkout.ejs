<%- include("../../views/partials/user/header") %>

<section class="breadcrumb-option" style="padding: 16px 0;">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="breadcrumb__text">
                    <h4>Check Out</h4>
                    <div class="breadcrumb__links">
                        <a href="/">Home</a>
                        <a href="/shop">Shop</a>
                        <a href="/cart">Shopping Cart</a>
                        <span>Checkout</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="checkout spad">
    <div class="container">
        <div class="row">
            <div class="col-lg-7 col-md-6">
                <div class="checkout__address" style="margin-top: 31px;">
                    <h4 class="order__title"><b>Select Address</b></h4>
                    <div class="checkout__address__list">
                        <% if (addresses && addresses.address.length > 0) { %>
                            <select name="selectedAddress" class="form-control" required>
                                <% addresses.address.forEach((address) => { %>
                                    <option value="<%= address._id %>">
                                        <%= address.name %>, <%= address.houseName %>, <%= address.street %>, 
                                        <%= address.city %>, <%= address.state %> - <%= address.pincode %>
                                    </option>
                                <% }) %>
                            </select>
                        <% } else { %>
                            <p class="text-danger">No addresses found. Please add an address in your Profile.</p>
                        <% } %>
                    </div>
                </div>
                <div class="checkout__payment">
                    <h4></h4>
                    <div class="form-check" style="position: relative;
                    top: 76px;
                    right: 333px;">
                        <h5><b><b>Payment Method</b></b></h5>
                        <input class="form-check-input" type="radio" name="paymentMethod" value="COD" checked required>
                        <label class="form-check-label">Cash on Delivery</label>
                    </div>
                </div>
            </div>

            <div class="col-lg-5 col-md-6">
                <div class="checkout__order" style="    margin-top: 51px;">
                    <h4 class="order__title">Your Order</h4>
                    <ul class="checkout__total__products">
                        <% cartItems.forEach((item, index) => { %>
                            <li>
                                <%= index + 1 %>. <%= item.productId.productName %> - Size: <%= item.size %>, 
                                Qty: <%= item.quantity %>, ₹<%= item.totalPrice.toFixed(2) %>
                            </li>
                        <% }) %>
                    </ul>
                    <ul class="checkout__total__all">
                        <li>Total: ₹<%= totalPrice.toFixed(2) %></li>
                    </ul>
                    <button id="place-order" class="site-btn">PLACE ORDER</button>
                </div>
            </div>
        </div>
    </div>
</section>

<%- include("../../views/partials/user/footer") %>

<script>
    document.querySelector("#place-order").addEventListener("click", async () => {
        const selectedAddress = document.querySelector("select[name='selectedAddress']").value;

        try {
            const response = await fetch("/place-order", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    selectedAddress,
                    paymentMethod: "COD",
                }),
            });

            const data = await response.json();

            if (data.success) {
                window.location.href = `/order-confirmation/${data.message}`;
            } else {
                alert(data.message || "Failed to place order. Try again.");
            }
        } catch (error) {
            console.error("Error placing order:", error);
            alert("An error occurred while placing your order. Please try again.");
        }
    });
</script>
